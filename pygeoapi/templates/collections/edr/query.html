{% extends "_base.html" %}
{% import "macros/map.html" as mapComponent %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
/ <a href="{{ data['collections_path'] }}">{% trans %}Collections{% endtrans %}</a>
{% for link in data['links'] %}
  {% if link.rel == 'collection' %} /
    <a href="{{ data['dataset_path'] }}">{{ link['title'] | truncate( 25 ) }}</a>
    {% set col_title = link['title'] %}
  {% endif %}
{% endfor %}
/ <a href="{{ data['items_path']}}">{% trans %}Items{% endtrans %}</a>
{% endblock %}

{% block body %}
  <section id="coverage">
    {% set mapScriptTag %}
    {% if data %}
        <script>
        var map = L.map('leaflet-map').setView([{{ 45 }}, {{ -75 }}], 5);
        map.addLayer(new L.TileLayer(
            '{{ config['server']['map']['url'] }}', {
                maxZoom: 18,
                attribution: '{{ config['server']['map']['attribution'] | safe }}'
            }
        ));

        var layers = L.control.layers(null, null, {collapsed: false}).addTo(map)

        var layer
        CovJSON.read(JSON.parse('{{ data | to_json | safe }}')).then(function (coverage) {
          layer = C.dataLayer(coverage, {parameter: 'SST'})
            .on('afterAdd', function () {
              C.legend(layer).addTo(map)
              map.fitBounds(layer.getBounds())
            })
            .addTo(map)
          layers.addOverlay(layer, 'Temperature')
          map.setZoom(5)
        })

        map.on('click', function (e) {
          new C.DraggableValuePopup({
            layers: [layer]
          }).setLatLng(e.latlng).openOn(map)
        })

    </script>
    {% endif %}
    {% endset %}
    {{ mapComponent.leafletMap(mapScriptTag, ["coverage"]) }}
  </section>
{% endblock %}
